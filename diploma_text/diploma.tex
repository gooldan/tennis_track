% Тут используется класс, установленный на сервере Papeeria. На случай, если
% текст понадобится редактировать где-то в другом месте, рядом лежит файл matmex-diploma-custom.cls
% который в момент своего создания был идентичен классу, установленному на сервере.
% Для того, чтобы им воспользоваться, замените matmex-diploma на matmex-diploma-custom
% Если вы работаете исключительно в Papeeria то мы настоятельно рекомендуем пользоваться
% классом matmex-diploma, поскольку он будет автоматически обновляться по мере внесения корректив
%

% По умолчанию используется шрифт 14 размера. Если нужен 12-й шрифт, уберите опцию [14pt]
\documentclass[14pt]{matmex-diploma}
%\documentclass[14pt]{matmex-diploma-custom}
\usepackage{amsmath}

\begin{document}
% Год, город, название университета и факультета предопределены,
% но можно и поменять.
% Если англоязычная титульная страница не нужна, то ее можно просто удалить.
\filltitle{ru}{
    chair              = {Математическое обеспечение и администрирование информационных систем\\ Информатика},
    title              = {Разработка подхода отслеживания компактных скоростных объектов с помощью системы камер},
    % Здесь указывается тип работы. Возможные значения:
    %   coursework - Курсовая работа
    %   diploma - Диплом специалиста
    %   master - Диплом магистра
    %   bachelor - Диплом бакалавра
    type               = {bachelor},
    position           = {студента},
    group              = 342,
    author             = {Щавелев Егор Михайлович},
    supervisorPosition = {ст. преп.},
    supervisor         = {Смирнов М.\,Н.},
    reviewerPosition = {доцент},
    reviewer = {Пименов А.\,А.},
%   university         = {Санкт-Петербургский Государственный Университет},
%   faculty            = {Математико-механический факультет},
%   city               = {Санкт-Петербург},
%   year               = {2013}
}
\filltitle{en}{
    chair              = {Software and Administration of Information Systems\\ 
Computer Science Department},
    title              = {Development of high-speed compact objects tracking using cameras system approach},
    % Здесь указывается тип работы. Возможные значения:
    %   coursework - Курсовая работа
    %   diploma - Диплом специалиста
    %   master - Диплом магистра
    %   bachelor - Диплом бакалавра
    type               = {bachelor},
    position           = {студента},
    group              = 342,
    author             = {Щавелев Егор Михайлович},
    supervisorPosition = {ст. преп.},
    supervisor         = {Смирнов М.\,Н.},
    reviewerPosition = {доцент},
    reviewer = {Пименов А.\,А.},
%   university         = {Санкт-Петербургский Государственный Университет},
%   faculty            = {Математико-механический факультет},
%   city               = {Санкт-Петербург},
%   year               = {2013}
}
\maketitle
\tableofcontents
% У введения нет номера главы
\section*{Введение}
В современный мир всё глубже и глубже проникают информационные технологии. Они затрагивают многие деятельности современного человека, начиная от его досуга и заканчивая прикладными программами и алгоритмами, отвечающими за жизни людей. Поддерживая текущий вектор информатизации и компьютеризации общества и его задач, математики, программисты и многие другие ученые и исследователи занимаются поиском решений и алгоритмов для вычислительных систем, направленных на упрощение и улучшение жизни человека.

В настоящее время современные компьютерные технологии повсеместно внедряются в жизнь и деятельность людей. Так, например, активно развивается интеграция компьютерных систем в сферу соревновательного спорта. Практически в каждом виде спорта сейчас так или иначе присутствуют решения, позволяющие делегировать обязанности судей и людей, ответственных за контроль игровых ситуаций компьюьтерной системе.

Для примера рассмотрим такой вид спорта как большой теннис. В 2001 году миру была представлена система Tennis Eye, позволяющая во время матча разрешать конфликтные ситуации по поводу попадания мяча в корт. Она отслеживает и предсказывает траекторию полета мяча с высокой точностью, и в настоящее время данная система используется во всех официальных теннисных матчах. Однако данная система, несмотря на ее высокую точность, зрелищность для зрителя и повсеместное применение, отличается своей высокой ценой и большим количеством обслуживающего персонала, необходимого для поддержания работоспособности всей системы.

Этот фактор сильно препятствует ее внедрению в повседневный тренировочный процесс профессиональных игроков, и на текущий момент времени во время тренировки спортсменов на корте есть необходимость использовать людей, в обязанности которых входит:
\begin{itemize}
\item Отслеживание активности игроков и их перемещений по корту;
\item Отслеживание траекторий полета мячей для оценки эффективности и правильности техники спортсменов;
\item Отслеживание физического показателей игроков для оценки их спортивной формы.
\end{itemize}

Благодаря развитию современных технологий, в частности, компьютерного зрения, часть этих задач можно делегировать компьютерной системе, которая могла бы отслеживать игроков и траектории полета мячей, что позволит освободить человека от такой рутинной и монотонной работы как скурпулезное заполнение многостраничных отчетов о прошедшей тренировке.

Задачу реализации такой системы можно разбить на несколько этапов, первым из которых является разработка системы отслеживания траектории полета мяча в реальном времени. Для реализации такого решения необходимо рассмотреть и реализовать подход к отслеживанию компактных скоростных объектов с помощью системы камер, что и являются целью настоящей работы.


\section{Постановка задачи}
В рамках настоящей бакалаврской работы ставились следующие задачи.
\begin{enumerate}
    \item Выполнить поиск и обзор существующих подходов к вычислению траектории движущихся объектов.
    \item Разработать алгоритм распознавания объектов в видеопотоке на примере задачи об отслеживании траектории теннисного мяча.
    \item Разработать подход к построению трехмерной траектории полета мяча на основе ректифицированной стереопары
\end{enumerate}
\section{Обзор существующих решений}
\subsection{Физическая интерпретация положения мяча в пространстве}
Существующие аналогичные решения представлены в виде научных работ и статей. Например, статья \cite{wiki:lc3d} описывает физическую интерпретацию полета мяча при игре в гольф. В частности, модель полета мяча описывается следующим образом:
Мяч предстваляется в виде сферического упругого объекта, на который во время движения действуют следующие силы: 
\begin{itemize}
\item $F_{m}$ -- сила Магнуса (подъемная сила);
\item $F_{r}$ -- сила сопротивления воздуха;
\item $F_{w}$ -- сила тяжести Земли.
\item $F$ -- равнодействующая всех сил
\end{itemize}

По второму закону Ньютона тогда получим следующее уравнение:\\
\begin{equation*} 
\begin{gathered}
ma=F_{w}+F_{r}+F_{m}
\end{gathered}
\end{equation*}
Данный вывод далее будет использован в настоящей работе в ходе вычисления абсолютного положения мяча в пространстве в физическом подходе решения задачи.

В работе \cite{wiki:lcd} подробно рассматривается физическая модель полета теннисного мяча и приводятся вычисления некоторых коэффициентов и значений для теннисных мячей. Так же рассмотрен случай с вращением мяча в двухмерном пространстве, однако вращается он только в одной оси. В физической модели, описанной в настоящей работе, вращение мяча может быть произвольным, что позволит строить траекторию еще точнее.
\subsection{Отслеживание мяча в пространстве}
В работе Robust 3D Tracking in Tennis Videos\cite{wiki:track} рассматривается подход, осуществляющий отслеживание трехмерной траектории мяча в процессе игры в теннис.

Данный подход основан на предложенном соревновании от компании 3D LIFE, в котором участникам предлагались несинхронизированные видео с 9 камер с процессом игры. Процесс отслеживания траектории описывался следующим образом:
\begin{itemize}
\item Выделение движущихся частей из видео
\item Фильтрация этих частей на основе их размеров и цвета
\item Добавление этих частей как кандидатов на мяч
\item Анализ дальнейших кадров для вычисления траектории кандидатов
\item Преобразование траекторий с двух камер в трехмерное пространство и затем проецирование этой траектории на третью камеру. Спроецированные траектории сравниваются с текущими траекториями и траектория с наименьшим отклонением считается действительной траекторией мяча.
\end{itemize}
Предложенный подход отличается своей эффективностью и простотой, однако у него есть некоторые недостатки, вызванные тем, что данный алгоритм подходит только для видео, его ракурсов съемки, световых и погодных условий, предоставленных организатором соревнований. Например, в алгоритме фигурирует некоторое количество констант, касающихся размеров мяча и его цвета. Таким образом, авторы этого алгоритма не смогут обрабатывать некоторые случаи, которые могут возникнуть в ходе эксплуатации этого подхода в различных условиях. Например, сильные удары по мячу или подачи мужчин в условиях освещения в помещении превращаются в растянутый закругленный прямоугольник. (Рис.~\ref{ris:ris1213}). \\

\begin{figure}
	\begin{minipage}{0.49\linewidth}
		\center{\includegraphics[width=1\linewidth]{bad_shot.jpg} }
	\end{minipage}
	\hfill
	\begin{minipage}{0.49\linewidth}
		\center{\includegraphics[width=1\linewidth]{bad_shot_b.jpg}}
	\end{minipage}
	\caption{Пример специфической формы мяча}
	\label{ris:ris1213}
\end{figure}

Также возможен случай, что мяч будет пролетать на фоне источника освещения, тогда он почти теряет свой желтый цвет, превращаясь в серое пятно. Похожая ситуация возникает и при игре на улице, вдали от камеры мяч тоже теряет свои цветовые характеристики (Рис.~\ref{ris:ris12131}).

\begin{figure}
	\begin{minipage}{0.4\linewidth}
		\center{\includegraphics[width=1\linewidth]{color.jpg} }
	\end{minipage}
	\hfill
	\begin{minipage}{0.4\linewidth}
		\center{\includegraphics[width=1\linewidth]{color_b.jpg}}
	\end{minipage}
	\caption{Пример специфического цвета мяча}
	\label{ris:ris12131}
\end{figure}
\section{Используемые технологии}
В рамках настоящей работы были использованы следующие технологии:

\begin{enumerate}
    \item Python 3 \cite{wiki:pyt}--  высокоуровневый язык программирования общего назначения. В частности, с его помощью осуществляется доступ к функциями библиотеки OpenCV.
    \item OpenCV 3.1.0 \cite{wiki:cv3} -- библиотека алгоритмов компьютерного зрения, обработки изображений и численных алгоритмов общего назначения с открытым кодом.
    \item Matlab R2016b \cite{wiki:matl3} --  пакет прикладных программ для решения задач технических вычислений и одноимённый язык программирования, используемый в этом пакете.
    \item Keras -- здесь будет краткое описание
    \item Theano -- здесь будет краткое описание
\end{enumerate}
\section{Основная часть}

Отслеживание движущихся объектов с помощью системы камер не предстваляется возможным без понимания, как эти объекты меняют свое положение в пространстве. Для этого необходимо рассмотреть физическую модель движения таких объектов. В частности, рассматривая модель перемещения мяча в пространстве, в работе \cite{wiki:lc3d} уже указаны  некоторые формулы и рассчеты сил, действующих на мяч для гольфа. Рассмотрим эту модель и перенесем на модель полета теннисного мяча.
\subsection{Физическая интерпретация положения мяча в пространстве}
Как уже было описано ранее, согласно второму закону Ньютона имеем следующее выражение:
\begin{equation*} 
\begin{gathered}
F=F_{w}+F_{r}+F_{m}
\end{gathered}
\end{equation*}
Рассмотрим проекции всех сил на 3 оси, примем ось $Z$ как ось, коллинеарную силе тяжести Земли. 
\begin{equation*} 
\begin{gathered}
F_{_x}=F_{r_x}+F_{m_x}\\
F_{_y}=F_{r_y}+F_{m_y}\\
F_{_z}=F_{w_z}+F_{r_z}+F_{m_z}
\end{gathered}
\end{equation*}
Распишем каждую силу по ее определению и формуле.
\subsubsection{Сила тяжести}
Исходя из определения силы тяжести -- сила тяжести есть произведение массы тела $m$ на ускорение свободного падения $g$:
\begin{equation*} 
\begin{gathered}
F_w=mg
\end{gathered}
\end{equation*}
\subsubsection{Сила сопротивления воздуха}
Основываясь на работе \cite{wiki:lcd}, имеем следующее выражение для определения силы сопротивления воздуха:
\begin{equation*} 
\begin{gathered}
F_r=C_dAdv^2/2
\end{gathered}
\end{equation*}
Где:
\begin{itemize}
     \item $C_d$ -- коэфициент сопротивления воздуха;
     \item $A$ -- площадь поперечного сечения мяча;
     \item $v$ -- скорость мяча;
     \item $d$ -- плостность среды, в нашем случае -- воздуха при нормальных условиях.
\end{itemize}
\subsubsection{Сила Магнуса}
В работе \cite{wiki:lcd} указана формула для расчета силы Магнуса:
\begin{equation*} 
\begin{gathered}
F_m=C_lAdv^2/2,
\end{gathered}
\end{equation*}
Где:
\begin{itemize}
    \item $C_l$ -- коэфициент подъемной силы, вычисляемый по формуле \begin{equation*} 
\begin{gathered}
{C_l=1/[2+(v/v_{spin})]},
\end{gathered}
\end{equation*}
где $v$ -- скорость мяча, а $v_{spin}$ -- скорость вращения мяча;
\item $A$ -- площадь поперечного сечения мяча.
\end{itemize}
\subsubsection{Решение системы уравнений}
Зная каким образом и какие силы действуют на мяч в течение его полета, можем расписать получившуюся систему:
\begin{equation*} 
\begin{gathered}
F_x=C_dAdv_x^2/2+1/[2+(v_x/v_{spin_x})]Adv_x^2/2,\\
F_y=C_dAdv_y^2/2+1/[2+(v_y/v_{spin_y})]Adv_y^2/2,\\
F_z=C_dAdv_z^2/2+1/[2+(v_z/v_{spin_z})]Adv_z^2/2+mg.
\end{gathered}
\end{equation*}
Представим данную систему уравнений как систему дифференциальных уравнений и запишем ее, принимая во внимание второй закон Ньютона. Тогда скорость будет являеться первой производной по времени, а ускорение -- второй:
\begin{equation*} 
\begin{gathered}
m\ddot{x}=C_dd\pi R^2v^2/2+1/[2+(v/wR)]d\pi R^2\dot{x}^2/2,\\
m\ddot{y}=C_dd\pi R^2v^2/2+1/[2+(v/wR)]d\pi R^2\dot{y}^2/2,\\
m\ddot{z}=C_dd\pi R^2v^2/2+1/[2+(v/wR)]d\pi R^2\dot{z}^2/2+mg
\end{gathered}
\end{equation*}
В дальнейшем необходимо решить эту систему уравнений, откуда получим координаты мяча в любой момент времени. Получив координаты, становится возможным как интерполировать так и экстраполировать траекторию мяча и использовать её для улучшения точности отслеживания объекта.
\subsection{Распознавание объектов в видеопотоке}
\subsubsection{Получение объектов, изменивших свое положение}

Имея непрерывный видеопоток предстваляется возможным выделить объекты, меняющие свое положение от кадра к кадру. Для этого используется библиотека OpenCV и алгоритм BackgroundSubtractorMOG2, представляющий собой алгоритм работающий на основе модели смесей гауссовских распределений\footnote{Gaussian Mixture Model} для сегментации объектов переднего/заднего плана[ref1,ref2]. Данный алгоритм более адаптивен к изменчивому освещению, что позволяет более четко сегментировать объекты, изменившие свое положение. В параметрах алгоритма можно указать количество кадров, которое будет участвовать в обработке и пороговое значение расстояния Махаланобиса между одним пикселем изображения и моделью смесей. В ходе исследования параметров было выяснено, что этот параметр косвенным образом отвечает за то, насколько объект должен быть различим относительно фона, что позволяет более тонко настраивать работу алгоритма для разных условий освещения. В рамках настоящей работы были определены какие параметры оптимальны для правильной работы алгоритма в зависимости от освещения, при котором производилась видеосъемка (Табл.~\ref{tabl:tabl1}).
\begin{table}[]
\centering
\caption{Оптимальные параметры алгоритма}
\label{tabl:tabl1}
\begin{tabular}{lllll}
\cline{1-4}
\multicolumn{1}{|l|}{Освещение}          & \multicolumn{1}{l|}{Уличное} & \multicolumn{1}{l|}{Спортивный зал} & \multicolumn{1}{l|}{Обычная комната} &  \\ \cline{1-4}
\multicolumn{1}{|l|}{История}            & \multicolumn{1}{l|}{100}     & \multicolumn{1}{l|}{500}            & \multicolumn{1}{l|}{50}              &  \\ \cline{1-4}
\multicolumn{1}{|l|}{Пороговое значение} & \multicolumn{1}{l|}{50}      & \multicolumn{1}{l|}{100}            & \multicolumn{1}{l|}{5}               &  \\ \cline{1-4}
                                         &                              &                                     &                                      & 
\end{tabular}
\end{table}
\subsubsection{Классификация объектов, изменивших свое положение}
На этом этапе имеется некоторое количество групп пикселей, которые соответсвуют реальным объектам, изменившим свое положение. В дальнейшем для построения траектории полета мяча, необходимо соотнести группу пикселей получившихся при вычитании фона и двухмерное текущее положение мяча на изображении. То есть, на получившейся разности кадров необходимо понять, где находится мяч. Для решения этой задачи существует несколько подходов. В рамках настоящей работы было проанализировано и реализовано несколько подходов и выбран наиболее оптимальный. Для начала рассмотрим типичную разность кадров видеопотока (Рис.~\ref{ris:ris2}).

\begin{figure}[h]
    \centering
    \includegraphics[width=1\textwidth]{polosa.png}
    \caption{Вычитание фона между двумя последовательными кадрами}
    \label{ris:ris2}
\end{figure}

На кадре можно наблюдать группу пикселей, представленную в виде закругленного прямоугольника, которая представляет собой несколько слившихся снимков мяча на одном кадре. Этот эффект возникает при съемке в помещении при низкой выдержке кадра, из-за того, что за время, пока матрица камеры принимает поток света, мяч успевает переместиться на достаточное расстояние, чтобы попасть на одно срабатывание затвора камеры несколько раз. Отсюда получается, что мяч иногда может быть представлен не обязательно в форме идеального шара, но и именно в виде закругленного прямоугольника, и это должен учитывать подход, выделяющий мяч на кадре.

Для начала рассмотрим подход, описанный в работе\cite{wiki:track}. Выделение мяча на кадре можно производить с помощью сливания группы находящихся рядом пикселей в описывающий их многоугольник и дальнеюшию фильтрацию всех получившихся многоугольников по площади и по усредненному значению их цвета на картинке. Однако, как уже было сказано ранее, такой подход не отличается универсальностью, так как он подразумевает, что площадь многоугольника, соответсвующего мячу на картинке никогда не превышает некой заданной наперед константы. Таким образом, данное ограничение не предусматривает возможности того, что мяч будет представлен в вышеописанной форме закругленного прямоугольника, так как зачастую площадь соответсвующего многоугольника соотносима с площадью многоугольника соответсвующего ракетке игрока. В ходе тестирования выяснилось, что при возникновения некоторого движения на фоне корта, такие движения могут определяться как мяч, хотя они могут быть представлены движениями болельщиков, полетом птиц и прочим. Поэтому данный подход непременим для решения настоящей задачи, поэтому предлагается рассмотреть другой подход.

Следующий подход подразумевает анализ формы и характера группы пикселей получившихся из разности кадров видео. В ходе исследования были выделены различные формы групп пикселей, соответсвующих мячу. Далее были выделены прочие объекты, которые не являлись мячом. Нетрудно заметить, что мяч чаще всего представлен в форме шара или растянутого шара в форме вышеописанного закругленного прямоугольника. Отсюда можно поставить задачу классификации формы группы пикселей на два класса:
\begin{enumerate}
    \item "Мяч"
    \item "Не мяч"
\end{enumerate}
Данная задача решалась с помощью современной технологии машинного обучения, а именно -- с помощью сверточных нейронных сетей. Для этого была использована библиотека Keras и подготовлена программа на языке Python, помогающая разметить человеку группу пикслей для последующего обучения. В ходе разметки видео было подготовлен следующий набор примеров классов для обучения (Табл.~\ref{tabl:dataset}).

\begin{table}[]
\centering
\caption{Подготовленный набор данных для обучения}
\label{tabl:dataset}
\begin{tabular}{lllll}
\cline{1-3}
\multicolumn{1}{|l|}{Классы}                  & \multicolumn{1}{l|}{"Мяч"} & \multicolumn{1}{l|}{"Не мяч"} &  &  \\ \cline{1-3}
\multicolumn{1}{|l|}{Участвовало в обучении (шт.)}  & \multicolumn{1}{l|}{700}   & \multicolumn{1}{l|}{1900}     &  &  \\ \cline{1-3}
\multicolumn{1}{|l|}{Участвовало в валидации (шт.)} & \multicolumn{1}{l|}{200}   & \multicolumn{1}{l|}{400}      &  &  \\ \cline{1-3}
                                              &                            &                               &  & 
\end{tabular}
\end{table}

В ходе обучения сверточной нейронной сети была достигнута точность 97\% на обучающем наборе данных и точность 95\% на валидационном наборе данных, что является достаточной точностью для классификации объектов в рамках решения настоящей задачи.

Для реализации такого подхода был выбран алгоритм, который можно описать следующим образом:
\begin{enumerate}
    \item Выделение контуров групп пикселей для текущего снимка разности кадров. Данный процесс был реализован с помощью функции библиотеки OpenCV findContours, которая на вход принимает двухцветное черно-белое изображение, в параметрах которой можно указать режим поиска контуров и метод их апроксимации. Для работы алгоритма был выбраны параметры CV\_RETR\_TREE и CV\_CHAIN\_APPROX\_SIMPLE по причине необходимости дальнейшей обработки полученной иерархии контуров.
    \item Следующим этапом является слияние близко расположенных контуров в один контур. Для этого вычисляется расстояние между центрами контуров и, если такое расстояние меньше заданной константы то такие контуры объединяются. В ходе исследования было выявлено что расстояние в 50 пикселей является оптимальным и удовлетворяет нормальной работе алгоритма.
    \item На следующем этапе рассмотренные контуры вписываются в окно размером 80х80 пикселей для передачи в нейросеть. После ответа нейросети информация о том, является ли этот контур мячом или нет сохраняется для дальнешей работы алгоритма.
\end{enumerate}

\subsubsection{Определение траектории в двухмерном случае}
На этом этапе имеется набор контуров с информацией является ли такой контур мячом или нет. Для построения двухмерной траектории мяча необходимо найти на следущем снимке разности кадров этот же мяч и соединить их центры. Однако, нужно учитывать, что могут возникать как ложнопозитивные так и ложнонегативные срабатывания ответа нейросети. Учитывая это, предлагается следующий алгоритм.


\begin{itemize}
    \item Начало алгоритма. Предположим, что до этого мяч не присутствовал на снимках разности кадров. Теперь, на текущем снимке, появились сведения, что на снимке присутствует мяч. Запомним его положение и будем ожидать следующего снимка. Дальше возможны следующие ситуации:   
    \begin{enumerate}
         \item На снимке отсутсвует мяч. Возвращаемся к началу алгоритма.
         \item На снимке присутствует один мяч. Получили траекторию полета мяча на двух снимках, продолжение работы алгоритма.
         \item На снимке присутствует несколько мячей. Выберем тот мяч, чей центр находится наиболее билзко к центру предыдущего положения мяча, не учитывая данные о других мячах переходим к пункту 2.
    \end{enumerate}
    \item Ожидаем следующий снимок разности кадров. При получении снимка рассматриваем вышеописанные ситуации.
\end{itemize}

Работа данного алгоритма продемонстрирована на рисунке ~\ref{ris:ris1}.



\begin{figure}[h]
    \centering
    \includegraphics[width=1\textwidth]{test.png}
    \caption{Траектория мяча}
    \label{ris:ris1}
\end{figure}

\subsection{Определение трехмерной траектории мяча}
\begin{figure}[h]
    \centering
    \includegraphics[width=1\textwidth]{3d.jpg}
    \caption{Трехмерное положение мяча}
    \label{ris:ris23434}
\end{figure}

\clearpage

% У заключения нет номера главы
\section*{Заключение}
В рамках бакалаврской работы были выполнены все поставленные задачи. 
\begin{enumerate}
    \item Рассмотрена физическая модель полета мяча, на основе которой можно реализовать алгоритм, вычисляющий положение мяча программно.
    \item Реализован алгоритм, распознающий мяч в видеопотоке и определеяющий его траекторию в двухмерном случае.
\end{enumerate}
\nocite{*}
\setmonofont[Mapping=tex-text]{CMU Typewriter Text}
\bibliographystyle{ugost2008ls}
\bibliography{diploma.bib}
\end{document}
